<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Live Streaming (ç”»é¢ï¼‹éŸ³å£°)</title>
<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
textarea{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
video{width:100%;border-radius:12px;background:#000}
.topbar{position:fixed;top:0;left:0;right:0;height:56px;background:#181818;border-bottom:1px solid #303030;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
.content{padding-top:72px}
.comment-list{max-height:200px;overflow-y:auto;}
.comment-item{border-bottom:1px solid #303030;padding:4px 0;}
</style>
</head>
<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <div>
    <button id="loginBtn" class="btn-blue">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" class="btn-gray hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="content">
<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>
  <button class="btn-red hidden" id="createBtn">ãƒ©ã‚¤ãƒ–ä½œæˆ</button>
</div>

<div id="streamer" class="page hidden">
  <h2 id="streamerTitle"></h2>
  <div class="panel">
    <button class="btn-blue" id="startBtn">ğŸ–¥ é…ä¿¡é–‹å§‹ (ç”»é¢ï¼‹éŸ³å£°)</button>
    <button class="btn-red" id="endBtn">â¹ é…ä¿¡çµ‚äº†</button>
  </div>
  <div class="panel">
    <textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
    <button class="btn-blue" id="sendComment">é€ä¿¡</button>
    <div id="commentList" class="comment-list"></div>
  </div>
</div>

<div id="viewer" class="page hidden">
  <h2 id="viewerTitle"></h2>
  <div class="panel">
    <video id="viewerVideo" autoplay playsinline></video>
  </div>
  <div class="panel">
    <div id="commentListViewer" class="comment-list"></div>
  </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, orderBy, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase
const app = initializeApp({
  apiKey: "AIzaSyDKNvq5KLhjhXx-SKWrgI-PRVbCfaST0Lk",
  authDomain: "k1t0-live-video.firebaseapp.com",
  projectId: "k1t0-live-video"
});
const auth = getAuth(app);
const db = getFirestore(app);

let myUid="", myName="", pc=null, localStream=null, currentStreamId=null;

// Auth
onAuthStateChanged(auth,u=>{
  if(!u) return;
  myUid=u.uid; myName=u.displayName;
  loginBtn.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  createBtn.classList.remove("hidden");
});

loginBtn.onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());
logoutBtn.onclick=async()=>{await signOut(auth);location.reload();};

// é…ä¿¡ä½œæˆ
createBtn.onclick=async()=>{
  const ref=await addDoc(collection(db,"liveStreams"),{ownerUid:myUid,ownerName:myName,createdAt:Date.now()});
  startStreaming(ref.id);
};

// é…ä¿¡é–‹å§‹
async function startStreaming(streamId){
  currentStreamId=streamId;
  home.classList.add("hidden");
  streamer.classList.remove("hidden");
  streamerTitle.textContent="ğŸ”´ é…ä¿¡ä¸­";

  // ç”»é¢ï¼‹ãƒã‚¤ã‚¯éŸ³å£°
  const screen = await navigator.mediaDevices.getDisplayMedia({video:false,audio:true});
  const mic = await navigator.mediaDevices.getUserMedia({audio:true});
  mic.getTracks().forEach(t=>screen.addTrack(t));
  localStream = screen;

  // WebRTC
  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

  // Offerç”Ÿæˆ
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  const offerRef = doc(db,"liveStreams",streamId,"offer","desc");
  await updateDoc(offerRef,{sdp:offer.sdp,type:offer.type}).catch(async()=>await offerRef.set({sdp:offer.sdp,type:offer.type}));

  // ICE
  pc.onicecandidate=e=>{ if(e.candidate) addDoc(collection(db,"liveStreams",streamId,"ice"),{candidate:e.candidate.toJSON()});};
}

// è¦–è´è€…å‚åŠ 
window.joinStream=async(id)=>{
  currentStreamId=id;
  home.classList.add("hidden");
  viewer.classList.remove("hidden");
  viewerTitle.textContent="è¦–è´ä¸­";

  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  pc.ontrack=e=>viewerVideo.srcObject=e.streams[0];

  // Offerå–å¾—
  const offerRef = doc(db,"liveStreams",id,"offer","desc");
  const offerSnap = await offerRef.get();
  const offerData = offerSnap.data();
  await pc.setRemoteDescription(offerData);

  // Answerç”Ÿæˆ
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await updateDoc(offerRef,{answer:{sdp:answer.sdp,type:answer.type}});

  // ICEå–å¾—
  const iceCol = collection(db,"liveStreams",id,"ice");
  onSnapshot(iceCol,snap=>{
    snap.docChanges().forEach(c=>{
      if(c.doc.data().candidate) pc.addIceCandidate(new RTCIceCandidate(c.doc.data().candidate));
    });
  });
};

// ã‚³ãƒ¡ãƒ³ãƒˆ
sendComment.onclick=async()=>{
  const text=commentInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"liveStreams",currentStreamId,"comments"),{name:myName,text,time:Date.now()});
  commentInput.value="";
};
onSnapshot(query(collection(db,"liveStreams",currentStreamId,"comments"),orderBy("time")),snap=>{
  commentList.innerHTML=""; commentListViewer.innerHTML="";
  snap.forEach(d=>{
    const c=d.data();
    commentList.innerHTML+=`<div class="comment-item"><strong>${c.name}</strong>: ${c.text}</div>`;
    commentListViewer.innerHTML+=`<div class="comment-item"><strong>${c.name}</strong>: ${c.text}</div>`;
  });
});

// é…ä¿¡çµ‚äº†
endBtn.onclick=async()=>{
  await deleteDoc(doc(db,"liveStreams",currentStreamId));
  pc?.close();
  streamer.classList.add("hidden"); home.classList.remove("hidden");
};
</script>
</body>
</html>
