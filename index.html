<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K1T0 Live</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Inter;background:#0b0b0d;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #222}
button{background:#111;border:1px solid #333;color:#fff;padding:8px 14px;border-radius:999px;cursor:pointer}
.video{aspect-ratio:16/9;background:#000;border-radius:14px;margin-bottom:12px}
.grid{padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.card{border:1px solid #222;border-radius:14px;padding:12px;cursor:pointer}
</style>
</head>

<body>

<header>
  <strong>K1T0 Live</strong>
  <button id="loginBtn">Google Login</button>
  <button id="createBtn" style="display:none">＋ Live作成</button>
</header>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc,
  setDoc, getDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0dDWCq0fawXBsk0IJTruqbKKM_-Cwqsw",
  authDomain: "k1t0-live-video-153cb.firebaseapp.com",
  projectId: "k1t0-live-video-153cb"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const provider = new GoogleAuthProvider();

const ADMIN_EMAILS = [
  "kito.0420jp@gmail.com",
  "masato.0420jp@gmail.com"
];

let user,isAdmin=false,streams=[];
let pc,localStream;

loginBtn.onclick = async()=> await signInWithPopup(auth, provider);

onAuthStateChanged(auth, async(u)=>{
  if(!u) return;
  user=u;
  isAdmin = ADMIN_EMAILS.includes(u.email);
  loginBtn.style.display="none";
  if(isAdmin) createBtn.style.display="inline-block";
  render();
});

createBtn.onclick = async()=>{
  const ref = await addDoc(collection(db,"streams"),{
    owner:user.uid,
    createdAt:Date.now()
  });
  location.hash = "live="+ref.id;
};

onSnapshot(collection(db,"streams"), snap=>{
  streams = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});

function createPC(streamId,isBroadcaster){
  pc = new RTCPeerConnection({
    iceServers:[{urls:"stun:stun.l.google.com:19302"}]
  });

  const iceRef = collection(db,"streams",streamId,"ice");

  pc.onicecandidate = e=>{
    if(e.candidate){
      addDoc(iceRef,{
        candidate:e.candidate.toJSON(),
        from:isBroadcaster?"host":"viewer"
      });
    }
  };

  if(!isBroadcaster){
    pc.ontrack = e=>{
      const v=document.createElement("video");
      v.autoplay=true;
      v.srcObject=e.streams[0];
      document.querySelector(".video").appendChild(v);
    };
  }

  onSnapshot(iceRef,snap=>{
    snap.docChanges().forEach(c=>{
      const d=c.doc.data();
      if(d.from!== (isBroadcaster?"host":"viewer")){
        pc.addIceCandidate(new RTCIceCandidate(d.candidate));
      }
    });
  });
}

async function startBroadcast(streamId){
  localStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
  createPC(streamId,true);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await setDoc(doc(db,"streams",streamId),{
    offer
  },{merge:true});

  onSnapshot(doc(db,"streams",streamId),snap=>{
    const d=snap.data();
    if(d.answer && !pc.currentRemoteDescription){
      pc.setRemoteDescription(new RTCSessionDescription(d.answer));
    }
  });

  const v=document.createElement("video");
  v.autoplay=true;
  v.muted=true;
  v.srcObject=localStream;
  document.querySelector(".video").appendChild(v);
}

async function startViewer(streamId){
  createPC(streamId,false);
  const ref=doc(db,"streams",streamId);

  onSnapshot(ref, async snap=>{
    const d=snap.data();
    if(d.offer && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await setDoc(ref,{answer},{merge:true});
    }
  });
}

function render(){
  const app=document.getElementById("app");

  if(location.hash.startsWith("#live=")){
    const id=location.hash.split("=")[1];
    app.innerHTML=`
      <div style="padding:20px">
        <div class="video"></div>
        ${isAdmin?
          `<button onclick="startBroadcast('${id}')">配信開始</button>`
          :
          `<small>視聴中…</small>`
        }
      </div>
    `;
    if(!isAdmin) startViewer(id);
    return;
  }

  app.innerHTML=`
    <div class="grid">
      ${streams.map(s=>`
        <div class="card" onclick="location.hash='live=${s.id}'">
          Live ${s.id}
        </div>
      `).join("")}
    </div>
  `;
}

window.startBroadcast=startBroadcast;
</script>

</body>
</html>
