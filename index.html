<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mini Live Streaming</title>
<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
h1,h2,h3{margin:0 0 12px}
small{color:#aaa}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
input,textarea{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
video{width:100%;border-radius:12px;background:#000}
.topbar{position:fixed;top:0;left:0;right:0;height:56px;background:#181818;border-bottom:1px solid #303030;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
.content{padding-top:72px}
.comment-list{max-height:200px;overflow-y:auto;}
.comment-item{border-bottom:1px solid #303030;padding:4px 0;display:flex;justify-content:space-between;align-items:center;}
</style>
</head>
<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <div>
    <button id="loginBtn" class="btn-blue">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <img id="homeAvatar" class="avatar hidden">
    <button id="logoutBtn" class="btn-gray hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="content">

<!-- HOME -->
<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>
  <div id="adminOnly" class="hidden">
    <button class="btn-red" onclick="openAdmin()">ç®¡ç†è€…ï¼šãƒ©ã‚¤ãƒ–ä½œæˆ</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSetup" class="page hidden">
  <button class="btn-gray" onclick="goHome()">â† æˆ»ã‚‹</button>
  <h2>ğŸ¬ ãƒ©ã‚¤ãƒ–ç®¡ç†</h2>
  <div class="panel">
    <input id="streamTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
    <button class="btn-red" onclick="startLive()">ğŸ”´ ãƒ©ã‚¤ãƒ–é–‹å§‹</button>
  </div>
</div>

<!-- STREAMER -->
<div id="streamer" class="page hidden">
  <h2 id="streamerTitle"></h2>

  <div class="panel">
    <video id="streamVideo" autoplay muted playsinline></video>
  </div>

  <div class="panel">
    <button id="btnScreen" class="btn-blue">ğŸ–¥ ç”»é¢å…±æœ‰</button>
    <button id="btnMic" class="btn-blue">ğŸ™ ãƒã‚¤ã‚¯ON</button>
    <button class="btn-red" onclick="endStream()">â¹ é…ä¿¡çµ‚äº†</button>
  </div>

  <div class="panel">
    ğŸ‘€ è¦–è´è€…æ•°ï¼š<span id="viewerCount">0</span> äºº
  </div>

  <div class="panel">
    <h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
    <textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
    <button class="btn-blue" onclick="sendComment()">é€ä¿¡</button>
    <div id="commentList" class="comment-list"></div>
  </div>
</div>

<!-- VIEWER -->
<div id="viewer" class="page hidden">
  <button class="btn-gray" onclick="goHome()">â† æˆ»ã‚‹</button>
  <h2 id="viewerTitle"></h2>

  <div class="panel">
    <video id="viewerVideo" autoplay playsinline></video>
  </div>

  <div class="panel">
    ğŸ‘€ è¦–è´è€…æ•°ï¼š<span id="viewerCountViewer">0</span> äºº
  </div>

  <div class="panel">
    <div id="commentListViewer" class="comment-list"></div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDKNvq5KLhjhXx-SKWrgI-PRVbCfaST0Lk",
  authDomain: "k1t0-live-video.firebaseapp.com",
  projectId: "k1t0-live-video"
});
const auth = getAuth(app);
const db = getFirestore(app);

let myUid="", myName="", myAvatar="";
let currentStreamId=null;
let pc=null;
let localStream=null;
let viewerDoc=null;
let isMicOn=true;
let viewersCol=null;

const ADMIN_EMAILS=["kito.0420jp@gmail.com","masato.0420jp@gmail.com"];
let isAdmin=false;

/* Auth */
onAuthStateChanged(auth,u=>{
  if(!u) return;
  myUid=u.uid; myName=u.displayName; myAvatar=u.photoURL;
  homeAvatar.src=myAvatar; homeAvatar.classList.remove("hidden");
  logoutBtn.classList.remove("hidden"); loginBtn.classList.add("hidden");
  isAdmin = ADMIN_EMAILS.includes(u.email);
  if(isAdmin) adminOnly.classList.remove("hidden");
});

loginBtn.onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());
logoutBtn.onclick=async()=>{await signOut(auth); location.reload();};

/* é…ä¿¡ä¸€è¦§ */
onSnapshot(query(collection(db,"liveStreams"),orderBy("createdAt","desc")),snap=>{
  streamList.innerHTML="";
  snap.forEach(d=>{
    const s=d.data();
    const isOwner = s.ownerUid===myUid;
    streamList.innerHTML+=`
      <div class="panel row">
        <img src="${s.ownerIcon}" class="avatar">
        <div class="col">
          <strong>${s.title}</strong><br>
          <small>${s.ownerName}</small>
        </div>
        <button class="btn-gray" onclick="joinStream('${d.id}')">å…¥å®¤</button>
        ${isOwner?`<button class="btn-red" onclick="deleteStream('${d.id}')">Ã—</button>`:""}
      </div>`;
  });
});

/* é…ä¿¡å‰Šé™¤ */
window.deleteStream=async(id)=>{if(confirm("ã“ã®é…ä¿¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db,"liveStreams",id));};

/* ä½œæˆ */
window.openAdmin=()=>{home.classList.add("hidden"); adminSetup.classList.remove("hidden");};
window.startLive=async()=>{
  const ref = await addDoc(collection(db,"liveStreams"),{
    title:streamTitle.value||"ç„¡é¡Œ",
    ownerUid:myUid,
    ownerName:myName,
    ownerIcon:myAvatar,
    createdAt:Date.now()
  });
  joinStream(ref.id,true);
};

/* å…¥å®¤ */
window.joinStream=async(id,isOwner=false)=>{
  currentStreamId=id;
  viewersCol = collection(db,"liveStreams",id,"viewers");

  if(isOwner){
    home.classList.add("hidden"); adminSetup.classList.add("hidden"); streamer.classList.remove("hidden");
    streamerTitle.textContent="ğŸ”´ é…ä¿¡ä¸­ï¼š"+streamTitle.value;

    // ã‚«ãƒ¡ãƒ©ã¨ãƒã‚¤ã‚¯
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    streamVideo.srcObject = localStream;

    // WebRTC
    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    const offerRef = doc(db,"liveStreams",currentStreamId,"offer","desc");
    await setDoc(offerRef,{sdp:offer.sdp,type:offer.type});

    pc.onicecandidate = e=>{if(e.candidate) addDoc(collection(db,"liveStreams",currentStreamId,"ice"),{candidate:e.candidate.toJSON()});};

  } else {
    home.classList.add("hidden"); viewer.classList.remove("hidden");

    const pc2 = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    pc2.ontrack = e=>viewerVideo.srcObject = e.streams[0];

    // Firestoreã‹ã‚‰offerå–å¾—
    const offerRef = doc(db,"liveStreams",currentStreamId,"offer","desc");
    const offerSnap = await offerRef.get();
    const offerData = offerSnap.data();
    await pc2.setRemoteDescription(offerData);

    const answer = await pc2.createAnswer();
    await pc2.setLocalDescription(answer);
    await setDoc(doc(db,"liveStreams",currentStreamId,"answer","desc"),{sdp:answer.sdp,type:answer.type});

    pc2.onicecandidate = e=>{if(e.candidate) addDoc(collection(db,"liveStreams",currentStreamId,"ice"),{candidate:e.candidate.toJSON()});};

    onSnapshot(collection(db,"liveStreams",currentStreamId,"ice"),snap=>{
      snap.docChanges().forEach(c=>{
        const data=c.doc.data();
        if(data.candidate) pc2.addIceCandidate(new RTCIceCandidate(data.candidate));
      });
    });
  }
};

/* ãƒã‚¤ã‚¯ON/OFF */
btnMic.onclick=()=>{
  if(!localStream) return;
  isMicOn = !isMicOn;
  localStream.getAudioTracks().forEach(t=>t.enabled=isMicOn);
  btnMic.textContent = isMicOn?"ğŸ™ ãƒã‚¤ã‚¯ON":"ğŸ™ ãƒã‚¤ã‚¯OFF";
};

/* ç”»é¢å…±æœ‰ */
btnScreen.onclick=async()=>{
  if(!localStream || !pc) return;
  const screenStream = await navigator.mediaDevices.getDisplayMedia({video:true});
  const videoTrack = screenStream.getVideoTracks()[0];
  const sender = pc.getSenders().find(s=>s.track.kind==="video");
  sender.replaceTrack(videoTrack);
  videoTrack.onended = ()=>sender.replaceTrack(localStream.getVideoTracks()[0]);
};

/* é…ä¿¡çµ‚äº† */
window.endStream=async()=>{if(confirm("é…ä¿¡ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")){await deleteDoc(doc(db,"liveStreams",currentStreamId));location.reload();}};

/* ã‚³ãƒ¡ãƒ³ãƒˆ */
window.sendComment=async()=>{
  const text = commentInput.value.trim(); if(!text) return;
  await addDoc(collection(db,"liveStreams",currentStreamId,"comments"),{name:myName||"åŒ¿å",text,time:Date.now()});
  commentInput.value="";
};

function loadComments(mode){
  const listId = mode==="streamer"?"commentList":"commentListViewer";
  const list = document.getElementById(listId);
  onSnapshot(query(collection(db,"liveStreams",currentStreamId,"comments"),orderBy("time")),snap=>{
    list.innerHTML="";
    snap.forEach(d=>{
      const c=d.data();
      const delBtn=isAdmin?` <button class="btn-red" onclick="deleteComment('${d.id}')">Ã—</button>`:"";
      list.innerHTML+=`<div class="comment-item"><span><strong>${c.name}</strong>: ${c.text}</span>${delBtn}</div>`;
    });
    list.scrollTop=list.scrollHeight;
  });
}
window.deleteComment=async(commentId)=>{if(confirm("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db,"liveStreams",currentStreamId,"comments",commentId));}

/* è¦–è´è€…æ•° */
function setupViewersCount(col,mode){
  const countSpan = mode==="streamer"?document.getElementById("viewerCount"):document.getElementById("viewerCountViewer");
  onSnapshot(col,snap=>{countSpan.textContent=snap.size;});
}

async function addViewer(col){
  if(!myUid) return;
  viewerDoc = doc(col,myUid);
  await setDoc(viewerDoc,{joinedAt:Date.now()});
  window.addEventListener("beforeunload",async()=>{await viewerDoc.delete().catch(()=>{});});
}

/* ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ */
window.goHome=()=>location.reload();
</script>
</body>
</html>
