<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K1T0 Live</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0b0d;
  --panel:#161616;
  --border:rgba(255,255,255,.08);
  --accent:#00e5ff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:#fff;
}
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:#111;
  border-bottom:1px solid var(--border);
}
button{
  background:transparent;
  border:1px solid var(--border);
  color:#fff;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
}
button.accent{
  border-color:var(--accent);
  box-shadow:0 0 12px rgba(0,229,255,.4);
}
.grid{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:16px;
}
.card{
  border-radius:14px;
  overflow:hidden;
  border:1px solid var(--border);
  background:#111;
  cursor:pointer;
}
.thumb{
  aspect-ratio:16/9;
  background:#000;
}
.meta{padding:12px}
.live{
  padding:20px;
}
video{
  width:100%;
  aspect-ratio:16/9;
  background:#000;
  border-radius:16px;
  border:1px solid var(--border);
  margin-bottom:16px;
}
</style>
</head>

<body>

<header>
  <strong>K1T0 Live</strong>
  <div>
    <button id="loginBtn" class="accent">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" style="display:none">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC0dDWCq0fawXBsk0IJTruqbKKM_-Cwqsw",
  authDomain: "k1t0-live-video-153cb.firebaseapp.com",
  projectId: "k1t0-live-video-153cb"
};

const fb = initializeApp(firebaseConfig);
const auth = getAuth(fb);
const db = getFirestore(fb);
const provider = new GoogleAuthProvider();

/* ===== State ===== */
const app = document.getElementById("app");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

let user = null;
let streams = [];
let pc;
let localStream;

/* ===== WebRTC è¨­å®šï¼ˆè¶…é‡è¦ï¼‰ ===== */
const rtcConfig = {
  iceServers:[
    { urls:"stun:stun.l.google.com:19302" }
  ]
};

/* ===== Auth ===== */
loginBtn.onclick = ()=>signInWithPopup(auth,provider);
logoutBtn.onclick = ()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  user = u;
  loginBtn.style.display = u ? "none":"inline-block";
  logoutBtn.style.display = u ? "inline-block":"none";
  render();
});

/* ===== Liveä½œæˆ ===== */
window.createLive = async ()=>{
  if(!user) return;
  const title = prompt("ãƒ©ã‚¤ãƒ–ã‚¿ã‚¤ãƒˆãƒ«");
  if(!title) return;

  const ref = await addDoc(collection(db,"streams"),{
    title,
    owner:user.uid,
    createdAt:Date.now()
  });
  location.hash = "live="+ref.id;
};

/* ===== é…ä¿¡ï¼ˆç”»é¢å…±æœ‰ï¼‰ ===== */
window.startBroadcast = async (id)=>{
  pc = new RTCPeerConnection(rtcConfig);

  localStream = await navigator.mediaDevices.getDisplayMedia({
    video:true,
    audio:true
  });

  document.getElementById("video").srcObject = localStream;

  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.onicecandidate = e=>{
    if(e.candidate){
      setDoc(doc(db,"signals",id),{
        offerCandidate:e.candidate
      },{merge:true});
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await setDoc(doc(db,"signals",id),{offer});
};

/* ===== è¦–è´ ===== */
window.watch = async (id)=>{
  pc = new RTCPeerConnection(rtcConfig);

  pc.ontrack = e=>{
    const v = document.getElementById("video");
    v.srcObject = e.streams[0];
    v.play();
  };

  pc.onicecandidate = e=>{
    if(e.candidate){
      setDoc(doc(db,"signals",id),{
        answerCandidate:e.candidate
      },{merge:true});
    }
  };

  onSnapshot(doc(db,"signals",id), async snap=>{
    const d = snap.data();
    if(!d) return;

    if(d.offer && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(d.offer);
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      await setDoc(doc(db,"signals",id),{answer:ans},{merge:true});
    }

    if(d.offerCandidate){
      try{await pc.addIceCandidate(d.offerCandidate);}catch{}
    }
    if(d.answerCandidate){
      try{await pc.addIceCandidate(d.answerCandidate);}catch{}
    }
  });
};

/* ===== Render ===== */
function render(){
  if(location.hash.startsWith("#live=")){
    const id = location.hash.split("=")[1];
    const s = streams.find(v=>v.id===id);
    if(!s){location.hash="";return;}

    app.innerHTML=`
      <div class="live">
        <video id="video" autoplay playsinline muted></video>
        <h3>${s.title}</h3>
        ${user && user.uid===s.owner
          ? `<button onclick="startBroadcast('${id}')">ğŸ¥ ç”»é¢å…±æœ‰é–‹å§‹</button>`
          : `<button onclick="watch('${id}')">â–¶ è¦–è´é–‹å§‹</button>`
        }
      </div>`;
    return;
  }

  app.innerHTML=`
    <div class="grid">
      ${user?`
      <div class="card" onclick="createLive()">
        <div class="thumb"></div>
        <div class="meta"><strong>ï¼‹ Liveä½œæˆ</strong></div>
      </div>`:""}
      ${streams.map(s=>`
        <div class="card" onclick="location.hash='live=${s.id}'">
          <div class="thumb"></div>
          <div class="meta"><strong>${s.title}</strong></div>
        </div>`).join("")}
    </div>`;
}

/* ===== Firestore ===== */
onSnapshot(collection(db,"streams"),snap=>{
  streams = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});
window.addEventListener("hashchange",render);
</script>

</body>
</html>
