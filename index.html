<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Live Streaming</title>

<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
h1,h2{margin:0 0 12px}
small{color:#aaa}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
input{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}

.topbar{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#181818;border-bottom:1px solid #303030;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;z-index:100
}
.content{padding-top:72px}
</style>
</head>

<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <div>
    <button id="loginBtn" class="btn-blue" onclick="login()">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <img id="homeAvatar" class="avatar hidden">
  </div>
</div>

<div class="content">

<!-- HOME -->
<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>
  <div id="adminOnly" class="hidden">
    <button class="btn-red" onclick="openAdmin()">ç®¡ç†è€…ï¼šãƒ©ã‚¤ãƒ–ä½œæˆ</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSetup" class="page hidden">
  <button class="btn-gray" onclick="backHome()">â† æˆ»ã‚‹</button>
  <h2>ğŸ¬ ãƒ©ã‚¤ãƒ–ç®¡ç†</h2>

  <div class="panel">
    <input id="streamTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
    <button class="btn-red" onclick="startLive()">ğŸ”´ ãƒ©ã‚¤ãƒ–é–‹å§‹</button>
    <button class="btn-gray" onclick="endLive()">â¹ ãƒ©ã‚¤ãƒ–çµ‚äº†</button>
  </div>
</div>

<!-- VIEWER -->
<div id="viewer" class="page hidden">
  <button class="btn-gray" onclick="backHome()">â† æˆ»ã‚‹</button>
  <h2 id="viewerTitle"></h2>

  <div class="panel">
    ğŸ‘€ è¦–è´è€…æ•°ï¼š<span id="viewerCount">0</span> äºº
  </div>

  <div class="panel">
    <strong>ğŸ“Š æŠ•ç¥¨</strong><br><br>
    <button class="btn-gray" onclick="vote(1)">ğŸ‘ è‰¯ã„</button>
    <button class="btn-gray" onclick="vote(-1)">ğŸ‘ å¾®å¦™</button>
    <div id="voteResult"><small>ã¾ã æŠ•ç¥¨ã¯ã‚ã‚Šã¾ã›ã‚“</small></div>
  </div>

  <div class="panel">
    <strong>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</strong>
    <input id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã">
    <button class="btn-blue" onclick="sendComment()">é€ä¿¡</button>
    <div id="commentList"></div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, deleteDoc, doc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDKNvq5KLhjhXx-SKWrgI-PRVbCfaST0Lk",
  authDomain: "k1t0-live-video.firebaseapp.com",
  projectId: "k1t0-live-video",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ç®¡ç†è€… */
const ADMIN_EMAILS = [
  "kito.0420jp@gmail.com",
  "masato.0420jp@gmail.com"
];

let myName="", myAvatar="", isAdmin=false;
let currentStreamId=null;
let myViewerDoc=null;

/* Login */
window.login = async () => {
  const res = await signInWithPopup(auth, new GoogleAuthProvider());
  const user = res.user;
  myName = user.displayName;
  myAvatar = user.photoURL;
  homeAvatar.src = myAvatar;
  homeAvatar.classList.remove("hidden");
  loginBtn.classList.add("hidden");
  if (ADMIN_EMAILS.includes(user.email)) {
    isAdmin = true;
    adminOnly.classList.remove("hidden");
  }
};

/* é…ä¿¡ä¸€è¦§ */
const q = query(collection(db,"liveStreams"),orderBy("createdAt","desc"));
onSnapshot(q,snap=>{
  streamList.innerHTML="";
  if(snap.empty){
    streamList.innerHTML="<small>ç¾åœ¨é…ä¿¡ä¸­ã®ãƒ©ã‚¤ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“</small>";
    return;
  }
  snap.forEach(d=>{
    const s=d.data();
    streamList.innerHTML+=`
      <div class="panel row">
        <img src="${s.ownerIcon}" class="avatar">
        <div class="col">
          <strong>${s.title}</strong><br>
          <small>${s.ownerName}</small>
        </div>
        <button class="btn-gray" onclick="joinViewer('${d.id}','${s.title}')">è¦–è´</button>
      </div>`;
  });
});

/* Admin */
window.openAdmin=()=>{
  home.classList.add("hidden");
  adminSetup.classList.remove("hidden");
};

window.startLive=async()=>{
  if(!isAdmin)return;
  const docRef=await addDoc(collection(db,"liveStreams"),{
    title:streamTitle.value||"ç„¡é¡Œã®é…ä¿¡",
    ownerName:myName,
    ownerIcon:myAvatar,
    createdAt:Date.now(),
    vote:0
  });
  currentStreamId=docRef.id;
};

window.endLive=async()=>{
  if(!isAdmin||!currentStreamId)return;
  await deleteDoc(doc(db,"liveStreams",currentStreamId));
  backHome();
};

/* Viewer */
window.joinViewer=async(id,title)=>{
  currentStreamId=id;
  viewerTitle.textContent=title;
  home.classList.add("hidden");
  viewer.classList.remove("hidden");

  // è¦–è´è€…ç™»éŒ²
  myViewerDoc = await addDoc(
    collection(db,"liveStreams",currentStreamId,"viewers"),
    { joined: Date.now() }
  );

  // è¦–è´è€…æ•°ç›£è¦–
  onSnapshot(
    collection(db,"liveStreams",currentStreamId,"viewers"),
    snap => viewerCount.textContent = snap.size
  );

  loadComments();
  loadVotes();
};

/* ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ è¦–è´è€…å‰Šé™¤ */
window.addEventListener("beforeunload", async()=>{
  if(currentStreamId && myViewerDoc){
    await deleteDoc(myViewerDoc);
  }
});

/* Vote */
window.vote=async(v)=>{
  await updateDoc(doc(db,"liveStreams",currentStreamId),{
    vote:increment(v)
  });
};

function loadVotes(){
  onSnapshot(doc(db,"liveStreams",currentStreamId),d=>{
    if(!d.exists())return;
    voteResult.innerHTML=`<small>æŠ•ç¥¨æ•°ï¼š${d.data().vote}</small>`;
  });
}

/* ã‚³ãƒ¡ãƒ³ãƒˆ */
function loadComments(){
  const qc=query(
    collection(db,"liveStreams",currentStreamId,"comments"),
    orderBy("time")
  );
  onSnapshot(qc,s=>{
    commentList.innerHTML="";
    s.forEach(d=>{
      const c=d.data();
      commentList.innerHTML+=`<small>${c.name}ï¼š${c.text}</small><br>`;
    });
  });
}

window.sendComment=async()=>{
  if(!commentInput.value)return;
  await addDoc(
    collection(db,"liveStreams",currentStreamId,"comments"),
    {
      name:myName||"åŒ¿å",
      text:commentInput.value,
      time:Date.now()
    }
  );
  commentInput.value="";
};

window.backHome=()=>location.reload();
</script>

</body>
</html>
