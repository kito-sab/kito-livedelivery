<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Live Streaming</title>

<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
h1,h2,h3{margin:0 0 8px}
small{color:#aaa}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
video{width:100%;background:#000;border-radius:12px}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
input{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
.comment{border-bottom:1px solid #303030;padding:6px 0;font-size:14px}
.badge-live{background:#ff0000;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}

.topbar{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#181818;border-bottom:1px solid #303030;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;z-index:100
}
.content{padding-top:72px}

.profile-card{
  position:absolute;top:56px;right:16px;width:260px;
  background:#181818;border:1px solid #303030;
  border-radius:12px;padding:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.6)
}
</style>
</head>

<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <img id="homeAvatar" class="avatar" src="https://placehold.co/40x40" onclick="toggleProfile()">
</div>

<div class="content">

<div id="profileCard" class="profile-card hidden">
  <div style="text-align:center">
    <img id="previewAvatar" class="avatar" style="width:64px;height:64px"><br><br>
    <input type="file" accept="image/*" onchange="changeAvatar(event)">
    <input id="profileName" placeholder="è¡¨ç¤ºå">
    <button class="btn-blue" onclick="saveProfile()">ä¿å­˜</button>
  </div>
</div>

<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>
  <button class="btn-gray" onclick="openAdmin()">ç®¡ç†è€…ãƒšãƒ¼ã‚¸</button>
</div>

<div id="adminSetup" class="page hidden">
  <button class="btn-gray" onclick="backHome()">â† æˆ»ã‚‹</button>
  <h2>ğŸ¬ é…ä¿¡ä½œæˆ</h2>
  <div class="panel">
    <input id="streamTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
    <button class="btn-red" onclick="startLive()">ğŸ”´ ãƒ©ã‚¤ãƒ–é–‹å§‹</button>
  </div>
</div>

<div id="liveAdmin" class="page hidden">
  <div class="panel">
    <span class="badge-live">LIVE</span>
    <video id="localVideo" autoplay muted></video>
  </div>

  <div class="panel">
    <h3>ğŸ¥ é…ä¿¡ / ç”»é¢å…±æœ‰</h3>
    <label><input type="checkbox" id="withAudio" checked> ç”»é¢éŸ³å£°ã‚’å«ã‚ã‚‹</label><br><br>
    <button class="btn-red" onclick="shareScreen()">ç”»é¢å…±æœ‰é–‹å§‹</button>
  </div>

  <div class="panel">
    <h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†</h3>
    <div id="adminComments"></div>
  </div>
</div>

<div id="viewer" class="page hidden">
  <button class="btn-gray" onclick="backHome()">â† æˆ»ã‚‹</button>
  <div class="panel">
    <span class="badge-live">LIVE</span>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div class="panel">
    <h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
    <div id="viewerComments"></div>
    <input id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã">
    <button class="btn-blue" onclick="sendComment()">é€ä¿¡</button>
  </div>
</div>

</div>

<script>
// ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« =====
let myName = localStorage.getItem("name") || "åç„¡ã—";
let myAvatar = localStorage.getItem("avatar") || "https://placehold.co/40x40";
homeAvatar.src = myAvatar;
previewAvatar.src = myAvatar;
profileName.value = myName;

function toggleProfile(){ profileCard.classList.toggle("hidden"); }
function changeAvatar(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>previewAvatar.src=r.result;
  r.readAsDataURL(f);
}
function saveProfile(){
  myName = profileName.value || "åç„¡ã—";
  myAvatar = previewAvatar.src;
  localStorage.setItem("name",myName);
  localStorage.setItem("avatar",myAvatar);
  homeAvatar.src = myAvatar;
  profileCard.classList.add("hidden");
}

// ===== é…ä¿¡ä¸€è¦§ =====
function renderStreams(){
  const list = streamList;
  list.innerHTML = "";
  const s = JSON.parse(localStorage.getItem("liveStream"));
  if(!s){ list.innerHTML="<small>ç¾åœ¨é…ä¿¡ä¸­ãªã—</small>"; return; }
  list.innerHTML = `
    <div class="panel row">
      <img src="${s.avatar}" class="avatar">
      <div class="col">
        <strong>${s.title}</strong><br>
        <small>é…ä¿¡è€…ï¼š${s.owner}</small>
      </div>
      <button class="btn-red" onclick="joinViewer()">å‚åŠ </button>
    </div>`;
}
renderStreams();

function openAdmin(){ home.classList.add("hidden"); adminSetup.classList.remove("hidden"); }
function backHome(){ location.reload(); }

function startLive(){
  localStorage.setItem("liveStream", JSON.stringify({
    title: streamTitle.value || "ç„¡é¡Œ",
    owner: myName,
    avatar: myAvatar
  }));
  adminSetup.classList.add("hidden");
  liveAdmin.classList.remove("hidden");
  renderStreams();
}

function joinViewer(){
  home.classList.add("hidden");
  viewer.classList.remove("hidden");
  initViewerRTC();
}

// ===== ã‚³ãƒ¡ãƒ³ãƒˆ =====
const bc = new BroadcastChannel("mini-live");

// ===== WebRTC =====
let pc;
let isAdmin = false;

async function shareScreen(){
  isAdmin = true;
  pc = createPC();

  const stream = await navigator.mediaDevices.getDisplayMedia({
    video:true,
    audio:withAudio.checked
  });
  localVideo.srcObject = stream;
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  bc.postMessage({type:"offer",offer});
}

function initViewerRTC(){
  pc = createPC();
}

function createPC(){
  const pc = new RTCPeerConnection();
  pc.onicecandidate = e=>{
    if(e.candidate) bc.postMessage({type:"ice",ice:e.candidate});
  };
  pc.ontrack = e=>{
    remoteVideo.srcObject = e.streams[0];
  };
  return pc;
}

bc.onmessage = async e=>{
  const d=e.data;

  if(d.type==="offer" && !isAdmin){
    await pc.setRemoteDescription(d.offer);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    bc.postMessage({type:"answer",answer:ans});
  }

  if(d.type==="answer" && isAdmin){
    await pc.setRemoteDescription(d.answer);
  }

  if(d.type==="ice"){
    try{ await pc.addIceCandidate(d.ice); }catch{}
  }

  if(d.type==="comment"){
    const h=`<div class="comment"><img src="${d.avatar}" class="avatar" style="width:24px;height:24px">
    <strong>${d.name}</strong> ${d.text}</div>`;
    adminComments.innerHTML+=h;
    viewerComments.innerHTML+=h;
  }
};

function sendComment(){
  if(!commentInput.value) return;
  bc.postMessage({type:"comment",name:myName,avatar:myAvatar,text:commentInput.value});
  commentInput.value="";
}
</script>

</body>
</html>
