<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Live Streaming</title>

<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
h1,h2,h3{margin:0 0 8px}
small{color:#aaa}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
video{width:100%;background:#000;border-radius:12px}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
input{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}

.topbar{position:fixed;top:0;left:0;right:0;height:56px;background:#181818;border-bottom:1px solid #303030;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
.content{padding-top:72px}
.profile-card{position:absolute;top:56px;right:16px;width:260px;background:#181818;border:1px solid #303030;border-radius:12px;padding:12px}
</style>
</head>

<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <div>
    <button id="loginBtn" class="btn-blue" onclick="login()">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <img id="homeAvatar" class="avatar hidden" onclick="toggleProfile()">
  </div>
</div>

<div class="content">

<div id="profileCard" class="profile-card hidden">
  <div style="text-align:center">
    <img id="previewAvatar" class="avatar" style="width:64px;height:64px"><br><br>
    <strong id="profileName"></strong>
  </div>
</div>

<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>

  <div id="adminOnly" class="hidden">
    <button class="btn-red" onclick="openAdmin()">ç®¡ç†è€…ï¼šãƒ©ã‚¤ãƒ–ä½œæˆ</button>
  </div>
</div>

<div id="adminSetup" class="page hidden">
  <button class="btn-gray" onclick="backHome()">â† æˆ»ã‚‹</button>
  <h2>ğŸ¬ ãƒ©ã‚¤ãƒ–ä½œæˆ</h2>
  <div class="panel">
    <input id="streamTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
    <button class="btn-red" onclick="startLive()">ğŸ”´ ãƒ©ã‚¤ãƒ–é–‹å§‹</button>
  </div>
</div>

</div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDKNvq5KLhjhXx-SKWrgI-PRVbCfaST0Lk",
  authDomain: "k1t0-live-video.firebaseapp.com",
  projectId: "k1t0-live-video",
  storageBucket: "k1t0-live-video.firebasestorage.app",
  messagingSenderId: "588013681766",
  appId: "1:588013681766:web:e108b7328a7a13948dc1a7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== ç®¡ç†è€…è¨­å®š =====
const ADMIN_EMAILS = [
  "kito.0420jp@gmail.com",
  "masato.0420jp@gmail.com"
];

let isAdmin = false;
let myName = "";
let myAvatar = "";

// ===== ãƒ­ã‚°ã‚¤ãƒ³ =====
const provider = new GoogleAuthProvider();
window.login = async function(){
  const res = await signInWithPopup(auth, provider);
  const user = res.user;

  myName = user.displayName;
  myAvatar = user.photoURL;

  homeAvatar.src = myAvatar;
  previewAvatar.src = myAvatar;
  profileName.innerText = myName;

  homeAvatar.classList.remove("hidden");
  loginBtn.classList.add("hidden");

  if (ADMIN_EMAILS.includes(user.email)) {
    isAdmin = true;
    adminOnly.classList.remove("hidden");
  }
};

// ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« =====
window.toggleProfile = function(){ profileCard.classList.toggle("hidden"); };

// ===== é…ä¿¡ä¸€è¦§ï¼ˆå…¨å“¡å…±æœ‰ï¼‰ =====
onSnapshot(collection(db, "liveStreams"), snap => {
  streamList.innerHTML = "";
  if (snap.empty) {
    streamList.innerHTML = "<small>ç¾åœ¨é…ä¿¡ä¸­ã®ãƒ©ã‚¤ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“</small>";
    return;
  }
  snap.forEach(doc => {
    const s = doc.data();
    streamList.innerHTML += `
      <div class="panel row">
        <img src="${s.ownerIcon}" class="avatar">
        <div class="col">
          <strong>${s.title}</strong><br>
          <small>é…ä¿¡è€…ï¼š${s.ownerName}</small>
        </div>
        <button class="btn-gray">è¦–è´</button>
      </div>`;
  });
});

// ===== ç®¡ç†è€…ï¼šãƒ©ã‚¤ãƒ–ä½œæˆ =====
window.openAdmin = function(){ home.classList.add("hidden"); adminSetup.classList.remove("hidden"); };
window.backHome = function(){ location.reload(); };

window.startLive = async function(){
  if (!isAdmin) return alert("ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™");

  await addDoc(collection(db, "liveStreams"), {
    title: streamTitle.value || "ç„¡é¡Œã®é…ä¿¡",
    ownerName: myName,
    ownerIcon: myAvatar,
    createdAt: Date.now()
  });

  alert("ãƒ©ã‚¤ãƒ–é–‹å§‹ã—ã¾ã—ãŸï¼");
  backHome();
};
</script>

</body>
</html>
