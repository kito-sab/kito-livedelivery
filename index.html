<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K1T0 Live</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0b0d;
  --panel:#161616;
  --border:rgba(255,255,255,.08);
  --accent:#00e5ff;
  --live:#ff2a2a;
  --sub:#aaa;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:#fff;
}
button{
  background:transparent;
  border:1px solid var(--border);
  color:#fff;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
}
button.accent{
  border-color:var(--accent);
  box-shadow:0 0 12px rgba(0,229,255,.4);
}
input{
  width:100%;
  padding:10px 14px;
  border-radius:10px;
  background:#0f0f0f;
  border:1px solid var(--border);
  color:#fff;
  margin-bottom:18px;
}
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:rgba(22,22,22,.7);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);
}
.grid{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:16px;
}
.card{
  border-radius:14px;
  overflow:hidden;
  border:1px solid var(--border);
  background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));
  cursor:pointer;
}
.thumb{
  aspect-ratio:16/9;
  background:#000;
}
.meta{padding:10px}

/* ===== LIVE ===== */
.live-page{padding:20px}
.video{
  position:relative;
  width:100%;
  max-width:1100px;
  margin:0 auto 20px;
  aspect-ratio:16/9;
  background:#000;
  border-radius:16px;
  overflow:hidden;
  border:1px solid var(--border);
}
.video video{
  width:100%;
  height:100%;
  object-fit:contain;
  background:#000;
}

/* ===== MODAL ===== */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal{
  width:320px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
}
</style>
</head>

<body>

<header>
  <strong>K1T0 Live</strong>
  <div>
    <button id="loginBtn" class="accent">Google „É≠„Ç∞„Ç§„É≥</button>
    <button id="logoutBtn" style="display:none">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
    <button id="createBtn" style="display:none" onclick="openCreate()">Ôºã Live‰ΩúÊàê</button>
  </div>
</header>

<div id="app"></div>

<!-- CREATE -->
<div class="modal-bg" id="createModal">
  <div class="modal">
    <strong>„É©„Ç§„Éñ‰ΩúÊàê</strong>
    <input id="newTitle" placeholder="„Çø„Ç§„Éà„É´">
    <button class="accent" onclick="createLive()">‰ΩúÊàê</button>
    <button onclick="closeCreate()">„Ç≠„É£„É≥„Çª„É´</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  doc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC0dDWCq0fawXBsk0IJTruqbKKM_-Cwqsw",
  authDomain: "k1t0-live-video-153cb.firebaseapp.com",
  projectId: "k1t0-live-video-153cb"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const provider = new GoogleAuthProvider();

/* ===== STATE ===== */
let user = null;
let streams = [];
let localStream = null;
let micEnabled = true;

/* ===== AUTH ===== */
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, u=>{
  user = u;
  loginBtn.style.display = u ? "none":"inline-block";
  logoutBtn.style.display = u ? "inline-block":"none";
  createBtn.style.display = u ? "inline-block":"none";
  render();
});

/* ===== CREATE ===== */
window.openCreate = ()=>createModal.style.display="flex";
window.closeCreate = ()=>createModal.style.display="none";

window.createLive = async ()=>{
  if(!user || !newTitle.value) return;
  const ref = await addDoc(collection(db,"streams"),{
    title:newTitle.value,
    owner:user.uid,
    createdAt:Date.now()
  });
  newTitle.value="";
  closeCreate();
  location.hash="live="+ref.id;
};

/* ===== MEDIA ===== */
async function startScreen(){
  localStream = await navigator.mediaDevices.getDisplayMedia({
    video:true,
    audio:true
  });
  showStream(localStream);
}

async function toggleMic(){
  if(!localStream){
    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  }
  micEnabled = !micEnabled;
  localStream.getAudioTracks().forEach(t=>t.enabled = micEnabled);
  alert("„Éû„Ç§„ÇØ " + (micEnabled ? "ON":"OFF"));
}

function showStream(stream){
  const container = document.querySelector(".video");
  container.innerHTML = "";

  const video = document.createElement("video");
  video.autoplay = true;
  video.muted = true;
  video.playsInline = true;
  video.srcObject = stream;

  container.appendChild(video);
}

/* ===== DELETE ===== */
window.endLive = async(id)=>{
  await deleteDoc(doc(db,"streams",id));
  location.hash="";
};

/* ===== RENDER ===== */
function render(){
  const app = document.getElementById("app");

  if(location.hash.startsWith("#live=")){
    const id = location.hash.split("=")[1];
    const s = streams.find(v=>v.id===id);
    if(!s){ location.hash=""; return; }

    app.innerHTML = `
      <div class="live-page">
        <div class="video"></div>
        <strong>${s.title}</strong><br><br>

        ${user && user.uid===s.owner ? `
          <button onclick="startScreen()">üñ• ÁîªÈù¢ÂÖ±Êúâ</button>
          <button onclick="toggleMic()">üé§ „Éû„Ç§„ÇØON/OFF</button>
          <button onclick="endLive('${id}')">ÁµÇ‰∫Ü</button>
        `:""}
      </div>
    `;
    return;
  }

  app.innerHTML = `
    <div class="grid">
      ${streams.map(s=>`
        <div class="card" onclick="location.hash='live=${s.id}'">
          <div class="thumb"></div>
          <div class="meta">
            <strong>${s.title}</strong>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}

/* ===== FIRESTORE ===== */
onSnapshot(collection(db,"streams"), snap=>{
  streams = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});

window.addEventListener("hashchange", render);
</script>

</body>
</html>
