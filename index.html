<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Live Streaming</title>
<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
h1,h2{margin:0 0 12px}
small{color:#aaa}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
input{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
video{width:100%;border-radius:12px;background:#000}
.topbar{position:fixed;top:0;left:0;right:0;height:56px;background:#181818;border-bottom:1px solid #303030;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
.content{padding-top:72px}
</style>
</head>
<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <div>
    <button id="loginBtn" class="btn-blue">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" class="btn-gray hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="content">

<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>
  <button class="btn-red hidden" id="adminBtn" onclick="openAdmin()">ç®¡ç†è€…ï¼šãƒ©ã‚¤ãƒ–ä½œæˆ</button>
</div>

<div id="adminSetup" class="page hidden">
  <button class="btn-gray" onclick="goHome()">â† æˆ»ã‚‹</button>
  <h2>ğŸ¬ ãƒ©ã‚¤ãƒ–ç®¡ç†</h2>
  <input id="streamTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
  <button class="btn-red" onclick="startLive()">ğŸ”´ ãƒ©ã‚¤ãƒ–é–‹å§‹</button>
</div>

<div id="streamer" class="page hidden">
  <h2 id="streamerTitle"></h2>
  <video id="streamVideo" autoplay muted playsinline></video>
  <button class="btn-blue" onclick="startScreen()">ğŸ–¥ ç”»é¢å…±æœ‰</button>
  <button class="btn-blue" onclick="startMic()">ğŸ™ ãƒã‚¤ã‚¯ON</button>
  <button class="btn-red" onclick="endLive()">ğŸ›‘ é…ä¿¡çµ‚äº†</button>
</div>

<div id="viewer" class="page hidden">
  <h2 id="viewerTitle"></h2>
  <video id="viewerVideo" autoplay playsinline></video>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDKNvq5KLhjhXx-SKWrgI-PRVbCfaST0Lk",
  authDomain: "k1t0-live-video.firebaseapp.com",
  projectId: "k1t0-live-video"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let myUid="", currentStreamId=null, pc=null, localStream=null;

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const adminBtn = document.getElementById("adminBtn");

onAuthStateChanged(auth, user => {
  if(user){
    myUid = user.uid;
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    adminBtn.classList.remove("hidden");
  }
});

loginBtn.onclick = ()=>signInWithPopup(auth,new GoogleAuthProvider());
logoutBtn.onclick = async()=>{await signOut(auth); location.reload();}

/* é…ä¿¡ä½œæˆ */
function openAdmin(){ home.classList.add("hidden"); adminSetup.classList.remove("hidden"); }

async function startLive(){
  const ref = await addDoc(collection(db,"liveStreams"),{
    title:document.getElementById("streamTitle").value||"ç„¡é¡Œ",
    ownerUid:myUid,
    createdAt:Date.now()
  });
  joinStream(ref.id);
}

/* é…ä¿¡çµ‚äº† */
async function endLive(){
  if(!currentStreamId) return;
  await deleteDoc(doc(db,"liveStreams",currentStreamId));
  location.reload();
}

/* é…ä¿¡ä¸€è¦§æ›´æ–° */
onSnapshot(query(collection(db,"liveStreams"),orderBy("createdAt","desc")), snap=>{
  const list = document.getElementById("streamList");
  list.innerHTML="";
  snap.forEach(d=>{
    const s=d.data();
    list.innerHTML += `<div>${s.title} <button onclick="joinStream('${d.id}')">å…¥å®¤</button></div>`;
  });
});

/* é…ä¿¡ã«å…¥å®¤ */
async function joinStream(id){
  currentStreamId = id;
  const streamDoc = doc(db,"liveStreams",id);

  onSnapshot(streamDoc, d=>{
    home.classList.add("hidden");
    adminSetup.classList.add("hidden");
    const data = d.data();
    if(data.ownerUid === myUid){
      streamer.classList.remove("hidden");
      document.getElementById("streamerTitle").textContent = "ğŸ”´ é…ä¿¡ä¸­: "+data.title;
      initStreamer();
    }else{
      viewer.classList.remove("hidden");
      document.getElementById("viewerTitle").textContent = data.title;
      initViewer();
    }
  });
}

/* --- WebRTC --- */
const servers = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
const offerRef = ()=>doc(db,"liveStreams",currentStreamId,"offer","desc");
const answerRef = ()=>doc(db,"liveStreams",currentStreamId,"answer","desc");
const iceRef = ()=>collection(db,"liveStreams",currentStreamId,"ice");

/* é…ä¿¡è€…åˆæœŸåŒ– */
async function initStreamer(){
  localStream = await navigator.mediaDevices.getUserMedia({audio:true}); // éŸ³å£°ã®ã¿åˆæœŸ
  document.getElementById("streamVideo").srcObject = localStream;

  pc = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.onicecandidate = e=>{ if(e.candidate) addDoc(iceRef(), e.candidate.toJSON()); }

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await updateDoc(offerRef(), {sdp: offer.sdp, type: offer.type}).catch(()=>addDoc(offerRef(), {sdp: offer.sdp, type: offer.type}));

  // answerç›£è¦–
  onSnapshot(answerRef(), snap=>{
    snap.docChanges().forEach(async change=>{
      if(change.type==="added"){
        const ans = change.doc.data();
        if(!pc.currentRemoteDescription) await pc.setRemoteDescription(ans);
      }
    });
  });
}

/* ç”»é¢å…±æœ‰ */
async function startScreen(){
  const screenStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
  screenStream.getTracks().forEach(t=>{
    pc.addTrack(t, screenStream);
    localStream.addTrack(t);
  });
  document.getElementById("streamVideo").srcObject = localStream;
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await updateDoc(offerRef(), {sdp: offer.sdp, type: offer.type});
}

/* ãƒã‚¤ã‚¯ON */
async function startMic(){
  const micStream = await navigator.mediaDevices.getUserMedia({audio:true});
  micStream.getTracks().forEach(t=>{
    pc.addTrack(t, micStream);
    localStream.addTrack(t);
  });
  document.getElementById("streamVideo").srcObject = localStream;
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await updateDoc(offerRef(), {sdp: offer.sdp, type: offer.type});
}

/* è¦–è´è€…åˆæœŸåŒ– */
async function initViewer(){
  pc = new RTCPeerConnection(servers);
  const videoEl = document.getElementById("viewerVideo");
  pc.ontrack = e=>{ videoEl.srcObject = e.streams[0]; }
  pc.onicecandidate = e=>{ if(e.candidate) addDoc(iceRef(), e.candidate.toJSON()); }

  // offerç›£è¦–
  onSnapshot(offerRef(), async snap=>{
    snap.docChanges().forEach(async change=>{
      if(change.type==="added"){
        const off = change.doc.data();
        await pc.setRemoteDescription(off);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await updateDoc(answerRef(), {sdp: answer.sdp, type: answer.type}).catch(()=>addDoc(answerRef(), {sdp: answer.sdp, type: answer.type}));
      }
    });
  });

  // ICEç›£è¦–
  onSnapshot(iceRef(), snap=>{
    snap.docChanges().forEach(async change=>{
      if(change.type==="added"){
        try{ await pc.addIceCandidate(change.doc.data()); }catch(e){ console.log(e);}
      }
    });
  });
}

window.goHome = ()=>location.reload();
</script>

</body>
</html>
