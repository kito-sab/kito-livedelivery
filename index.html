<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Live Streaming</title>
<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
input{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
video{width:100%;border-radius:12px;background:#000}
.topbar{position:fixed;top:0;left:0;right:0;height:56px;background:#181818;border-bottom:1px solid #303030;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
.content{padding-top:72px}
</style>
</head>
<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <div>
    <button id="loginBtn" class="btn-blue">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <img id="homeAvatar" class="avatar hidden" style="width:40px;height:40px;border-radius:50%">
    <button id="logoutBtn" class="btn-gray hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="content">

<!-- HOME -->
<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>
  <div id="adminOnly" class="hidden">
    <button class="btn-red" onclick="openAdmin()">ç®¡ç†è€…ï¼šãƒ©ã‚¤ãƒ–ä½œæˆ</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSetup" class="page hidden">
  <button class="btn-gray" onclick="goHome()">â† æˆ»ã‚‹</button>
  <h2>ğŸ¬ ãƒ©ã‚¤ãƒ–ç®¡ç†</h2>
  <div class="panel">
    <input id="streamTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
    <button class="btn-red" onclick="startLive()">ğŸ”´ ãƒ©ã‚¤ãƒ–é–‹å§‹</button>
  </div>
</div>

<!-- STREAMER -->
<div id="streamer" class="page hidden">
  <h2 id="streamerTitle"></h2>
  <div class="panel">
    <video id="streamVideo" autoplay muted playsinline></video>
  </div>
  <div class="panel">
    <button class="btn-blue" onclick="startScreen()">ğŸ–¥ ç”»é¢å…±æœ‰</button>
    <button class="btn-blue" onclick="startMic()">ğŸ™ ãƒã‚¤ã‚¯ON</button>
  </div>
  <div class="panel">
    <button class="btn-red" onclick="endLive()">ğŸ›‘ é…ä¿¡çµ‚äº†</button>
  </div>
</div>

<!-- VIEWER -->
<div id="viewer" class="page hidden">
  <button class="btn-gray" onclick="goHome()">â† æˆ»ã‚‹</button>
  <h2 id="viewerTitle"></h2>
  <div class="panel">
    ğŸ‘€ è¦–è´è€…æ•°ï¼š<span id="viewerCount">0</span> äºº
  </div>
  <div class="panel">
    <video id="viewerVideo" autoplay playsinline></video>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, onSnapshot, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDKNvq5KLhjhXx-SKWrgI-PRVbCfaST0Lk",
  authDomain: "k1t0-live-video.firebaseapp.com",
  projectId: "k1t0-live-video"
});
const auth = getAuth(app);
const db = getFirestore(app);

let myUid="", myName="", myAvatar="";
let currentStreamId=null;
let localStream=null;
let pc=null;

/* Auth */
onAuthStateChanged(auth, u => {
  if(!u) return;
  myUid = u.uid;
  myName = u.displayName;
  myAvatar = u.photoURL;
  homeAvatar.src = myAvatar;
  homeAvatar.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  loginBtn.classList.add("hidden");
  adminOnly.classList.remove("hidden");
});

loginBtn.onclick = () => signInWithPopup(auth,new GoogleAuthProvider());
logoutBtn.onclick = async()=>{ await signOut(auth); location.reload(); };

/* é…ä¿¡ä¸€è¦§è¡¨ç¤º */
onSnapshot(collection(db,"liveStreams"), snap => {
  streamList.innerHTML="";
  snap.forEach(d=>{
    const s = d.data();
    streamList.innerHTML += `
      <div class="panel row">
        <div class="col"><strong>${s.title}</strong><br><small>${s.ownerName}</small></div>
        <button class="btn-gray" onclick="joinStream('${d.id}')">å…¥å®¤</button>
      </div>
    `;
  });
});

/* ç®¡ç†è€…ç”»é¢ */
window.openAdmin = ()=>{ home.classList.add("hidden"); adminSetup.classList.remove("hidden"); }

window.startLive = async()=>{
  const ref = await addDoc(collection(db,"liveStreams"),{
    title: streamTitle.value||"ç„¡é¡Œ",
    ownerUid: myUid,
    ownerName: myName,
    ownerIcon: myAvatar,
    createdAt: Date.now(),
    viewers:0
  });
  joinStream(ref.id);
}

window.endLive = async()=>{
  if(!currentStreamId) return;
  await deleteDoc(doc(db,"liveStreams",currentStreamId));
  location.reload();
}

/* é…ä¿¡è€…ï¼šç”»é¢å…±æœ‰ï¼‹ãƒã‚¤ã‚¯ */
async function startScreen(){
  const screenStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
  if(!localStream) localStream = screenStream;
  else screenStream.getTracks().forEach(t => localStream.addTrack(t));

  if(!pc) initPeerConnection();
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  streamVideo.srcObject = localStream;
}

async function startMic(){
  const micStream = await navigator.mediaDevices.getUserMedia({audio:true});
  if(!localStream) localStream = micStream;
  else micStream.getTracks().forEach(t => localStream.addTrack(t));

  if(!pc) initPeerConnection();
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  streamVideo.srcObject = localStream;
}

/* WebRTC åˆæœŸåŒ– */
function initPeerConnection(){
  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

  const offerRef = collection(db,"liveStreams",currentStreamId,"offer");
  const answerRef = collection(db,"liveStreams",currentStreamId,"answer");
  const iceRef = collection(db,"liveStreams",currentStreamId,"ice");

  pc.onicecandidate = e => { if(e.candidate) addDoc(iceRef,e.candidate.toJSON()); }

  pc.createOffer().then(offer => pc.setLocalDescription(offer))
                 .then(()=> addDoc(offerRef, pc.localDescription.toJSON()));

  onSnapshot(answerRef, snapshot=>{
    snapshot.docChanges().forEach(async change=>{
      if(change.type==="added" && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(change.doc.data());
      }
    });
  });

  onSnapshot(iceRef, snapshot=>{
    snapshot.docChanges().forEach(async change=>{
      if(change.type==="added") try{ await pc.addIceCandidate(change.doc.data()); } catch(e){console.log(e);}
    });
  });
}

/* è¦–è´è€…å…¥å®¤ */
async function joinStream(id){
  currentStreamId = id;

  const docRef = doc(db,"liveStreams",id);
  onSnapshot(docRef, d=>{
    const s = d.data();
    home.classList.add("hidden");
    adminSetup.classList.add("hidden");

    if(s.ownerUid === myUid){
      streamer.classList.remove("hidden");
      streamerTitle.textContent = "ğŸ”´ é…ä¿¡ä¸­ï¼š" + s.title;
    } else {
      viewer.classList.remove("hidden");
      viewerTitle.textContent = s.title;
      joinViewer();
    }

    // è¦–è´è€…æ•°æ›´æ–°
    if(s.ownerUid !== myUid) updateDoc(docRef,{viewers: increment(1)});
    if(viewerCount) viewerCount.textContent = s.viewers || 0;
  });
}

/* è¦–è´è€…ï¼šç”»é¢ï¼‹éŸ³å£°å—ä¿¡ */
async function joinViewer(){
  const pcViewer = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  const viewerVideo = document.getElementById("viewerVideo");
  pcViewer.ontrack = e => { viewerVideo.srcObject = e.streams[0]; }

  const offerRef = collection(db,"liveStreams",currentStreamId,"offer");
  const answerRef = collection(db,"liveStreams",currentStreamId,"answer");
  const iceRef = collection(db,"liveStreams",currentStreamId,"ice");

  pcViewer.onicecandidate = e => { if(e.candidate) addDoc(iceRef,e.candidate.toJSON()); }

  onSnapshot(offerRef, async snapshot=>{
    snapshot.docChanges().forEach(async change=>{
      if(change.type==="added"){
        await pcViewer.setRemoteDescription(change.doc.data());
        const answer = await pcViewer.createAnswer();
        await pcViewer.setLocalDescription(answer);
        await addDoc(answerRef, pcViewer.localDescription.toJSON());
      }
    });
  });

  onSnapshot(iceRef, snapshot=>{
    snapshot.docChanges().forEach(async change=>{
      if(change.type==="added") try{ await pcViewer.addIceCandidate(change.doc.data()); } catch(e){console.log(e);}
    });
  });
}

window.goHome = ()=>location.reload();
</script>

</body>
</html>
