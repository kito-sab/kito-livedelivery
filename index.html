<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K1T0 Live</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0b0d;
  --panel:#161616;
  --border:rgba(255,255,255,.08);
  --accent:#00e5ff;
  --sub:#aaa;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:#fff;
}
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:rgba(22,22,22,.7);
  border-bottom:1px solid var(--border);
}
button{
  background:transparent;
  border:1px solid var(--border);
  color:#fff;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
}
button.accent{
  border-color:var(--accent);
  box-shadow:0 0 12px rgba(0,229,255,.4);
}
.grid{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:16px;
}
.card{
  border-radius:14px;
  overflow:hidden;
  border:1px solid var(--border);
  background:#111;
  cursor:pointer;
  transition:.2s;
}
.card:hover{transform:translateY(-3px)}
.thumb{aspect-ratio:16/9;background:#000}
.meta{padding:12px}

/* ===== LIVE ===== */
.live-layout{
  display:flex;
  height:calc(100vh - 56px);
}
.live-main{
  flex:1;
  padding:20px;
}
video{
  width:100%;
  aspect-ratio:16/9;
  background:#000;
  border-radius:16px;
  border:1px solid var(--border);
  margin-bottom:12px;
}
.controls button{margin-right:8px}

/* ===== CHAT ===== */
.chat-panel{
  width:320px;
  background:#111;
  border-left:1px solid var(--border);
  display:flex;
  flex-direction:column;
  transition:.3s;
}
.chat-panel.closed{
  transform:translateX(100%);
}
.chat-header{
  height:48px;
  display:flex;
  align-items:center;
  gap:10px;
  padding:0 10px;
  border-bottom:1px solid var(--border);
}
.chat-header button{
  width:32px;height:32px;border-radius:50%;
}
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg{font-size:14px;margin-bottom:6px}
.msg span{color:var(--sub)}
.chat-input{
  display:flex;
  gap:8px;
  padding:10px;
  border-top:1px solid var(--border);
}
.chat-input input{
  flex:1;
  padding:8px 12px;
  border-radius:999px;
  background:#000;
  border:1px solid var(--border);
  color:#fff;
}
</style>
</head>

<body>

<header>
  <strong>K1T0 Live</strong>
  <div>
    <button id="loginBtn" class="accent">Google„É≠„Ç∞„Ç§„É≥</button>
    <button id="logoutBtn" style="display:none">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
  </div>
</header>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyC0dDWCq0fawXBsk0IJTruqbKKM_-Cwqsw",
  authDomain: "k1t0-live-video-153cb.firebaseapp.com",
  projectId: "k1t0-live-video-153cb"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const provider = new GoogleAuthProvider();

let user=null;
let streams=[];
let pc;
let localStream;
let currentLiveId=null;

/* AUTH */
loginBtn.onclick=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  user=u;
  loginBtn.style.display=u?"none":"inline-block";
  logoutBtn.style.display=u?"inline-block":"none";
  render();
});

/* CREATE LIVE */
async function createLive(){
  const title=prompt("„É©„Ç§„Éñ„Çø„Ç§„Éà„É´");
  if(!title||!user)return;
  const ref=await addDoc(collection(db,"streams"),{
    title,owner:user.uid,createdAt:Date.now()
  });
  location.hash="live="+ref.id;
}

/* WEBRTC */
window.startBroadcast=async(id)=>{
  pc=new RTCPeerConnection();
  localStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
  video.srcObject=localStream;
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await setDoc(doc(db,"signals",id),{offer});
};

window.watch=async(id)=>{
  pc=new RTCPeerConnection();
  pc.ontrack=e=>video.srcObject=e.streams[0];
  const snap=await getDoc(doc(db,"signals",id));
  if(!snap.exists())return;
  const {offer}=snap.data();
  await pc.setRemoteDescription(offer);
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await setDoc(doc(db,"signals",id),{offer,answer});
};

/* CHAT */
function listenChat(id){
  onSnapshot(collection(db,"streams",id,"chat"),snap=>{
    messages.innerHTML=snap.docs.map(d=>{
      const m=d.data();
      return `<div class="msg"><span>${m.name}</span>: ${m.text}</div>`;
    }).join("");
  });
}
window.sendMessage=async()=>{
  if(!user||!chatText.value)return;
  await addDoc(collection(db,"streams",currentLiveId,"chat"),{
    text:chatText.value,
    name:user.displayName,
    createdAt:serverTimestamp()
  });
  chatText.value="";
};

/* RENDER */
function render(){
  if(location.hash.startsWith("#live=")){
    const id=location.hash.split("=")[1];
    const s=streams.find(v=>v.id===id);
    if(!s){location.hash="";return;}
    currentLiveId=id;

    app.innerHTML=`
      <div class="live-layout">
        <div class="live-main">
          <video id="video" autoplay playsinline></video>
          <strong>${s.title}</strong><br><br>
          <div class="controls">
            ${user&&user.uid===s.owner
              ? `<button onclick="startBroadcast('${id}')">üé• ÈÖç‰ø°ÈñãÂßã</button>
                 <button onclick="localStream && (localStream.getAudioTracks()[0].enabled=!localStream.getAudioTracks()[0].enabled)">üé§ „Éû„Ç§„ÇØ</button>`
              : `<button onclick="watch('${id}')">‚ñ∂ Ë¶ñËÅ¥</button>`
            }
          </div>
        </div>

        <div id="chatPanel" class="chat-panel">
          <div class="chat-header">
            <button id="toggleChat">‚ñ∂</button>
            <strong>„ÉÅ„É£„ÉÉ„Éà</strong>
          </div>
          <div id="messages"></div>
          <div class="chat-input">
            <input id="chatText" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏">
            <button onclick="sendMessage()">ÈÄÅ‰ø°</button>
          </div>
        </div>
      </div>`;

    document.getElementById("toggleChat").onclick=()=>{
      chatPanel.classList.toggle("closed");
      toggleChat.textContent=chatPanel.classList.contains("closed")?"‚óÄ":"‚ñ∂";
    };

    listenChat(id);
    return;
  }

  app.innerHTML=`
    <div class="grid">
      ${user?`<div class="card" onclick="createLive()">
        <div class="thumb"></div>
        <div class="meta"><strong>Ôºã Live‰ΩúÊàê</strong></div>
      </div>`:""}
      ${streams.map(s=>`
        <div class="card" onclick="location.hash='live=${s.id}'">
          <div class="thumb"></div>
          <div class="meta"><strong>${s.title}</strong></div>
        </div>`).join("")}
    </div>`;
}

onSnapshot(collection(db,"streams"),snap=>{
  streams=snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});
window.addEventListener("hashchange",render);
</script>

</body>
</html>
