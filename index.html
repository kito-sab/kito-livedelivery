<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Live Streaming</title>

<style>
body{margin:0;background:#0f0f0f;color:#f1f1f1;font-family:system-ui}
h1,h2{margin:0 0 12px}
small{color:#aaa}
.hidden{display:none}
.page{padding:16px}
.panel{background:#181818;border:1px solid #303030;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
button{border:none;border-radius:18px;padding:8px 16px;font-weight:700;cursor:pointer}
.btn-red{background:#cc0000;color:#fff}
.btn-blue{background:#065fd4;color:#fff}
.btn-gray{background:#303030;color:#fff}
input{width:100%;background:#121212;border:1px solid #303030;border-radius:8px;padding:8px;color:#fff;margin-bottom:8px}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}

.topbar{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#181818;border-bottom:1px solid #303030;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;z-index:100
}
.content{padding-top:72px}
</style>
</head>

<body>

<div class="topbar">
  <strong>ğŸ“º Mini Live</strong>
  <div id="authArea">
    <button id="loginBtn" class="btn-blue" onclick="login()">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <img id="homeAvatar" class="avatar hidden">
    <button id="logoutBtn" class="btn-gray hidden" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="content">

<!-- HOME -->
<div id="home" class="page">
  <h1>é…ä¿¡ä¸€è¦§</h1>
  <div id="streamList"></div>
  <div id="adminOnly" class="hidden">
    <button class="btn-red" onclick="openAdmin()">ç®¡ç†è€…ï¼šãƒ©ã‚¤ãƒ–ä½œæˆ</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSetup" class="page hidden">
  <button class="btn-gray" onclick="goHome()">â† æˆ»ã‚‹</button>
  <h2>ğŸ¬ ãƒ©ã‚¤ãƒ–ç®¡ç†</h2>
  <div class="panel">
    <input id="streamTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
    <button class="btn-red" onclick="startLive()">ğŸ”´ ãƒ©ã‚¤ãƒ–é–‹å§‹</button>
  </div>
</div>

<!-- VIEWER -->
<div id="viewer" class="page hidden">
  <button class="btn-gray" onclick="goHome()">â† æˆ»ã‚‹</button>
  <h2 id="viewerTitle"></h2>

  <div class="panel">
    ğŸ‘€ è¦–è´è€…æ•°ï¼š<span id="viewerCount">0</span> äºº
  </div>

  <div class="panel">
    <button class="btn-gray" onclick="vote(1)">ğŸ‘</button>
    <button class="btn-gray" onclick="vote(-1)">ğŸ‘</button>
    <div id="voteResult"><small>æŠ•ç¥¨ãªã—</small></div>
  </div>

  <div class="panel">
    <input id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ">
    <button class="btn-blue" onclick="sendComment()">é€ä¿¡</button>
    <div id="commentList"></div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup,
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, deleteDoc, doc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyDKNvq5KLhjhXx-SKWrgI-PRVbCfaST0Lk",
  authDomain: "k1t0-live-video.firebaseapp.com",
  projectId: "k1t0-live-video"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* ç®¡ç†è€… */
const ADMIN_EMAILS = [
  "kito.0420jp@gmail.com",
  "masato.0420jp@gmail.com"
];

let myName="", myAvatar="", isAdmin=false;
let currentStreamId=null;

/* ğŸ” ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ä¿æŒ */
onAuthStateChanged(auth,user=>{
  if(!user)return;
  myName=user.displayName;
  myAvatar=user.photoURL;
  homeAvatar.src=myAvatar;
  homeAvatar.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  loginBtn.classList.add("hidden");

  if(ADMIN_EMAILS.includes(user.email)){
    isAdmin=true;
    adminOnly.classList.remove("hidden");
  }
});

/* Login / Logout */
window.login=()=>signInWithPopup(auth,new GoogleAuthProvider());
window.logout=async()=>{await signOut(auth);location.reload();};

/* é…ä¿¡ä¸€è¦§ */
onSnapshot(
  query(collection(db,"liveStreams"),orderBy("createdAt","desc")),
  snap=>{
    streamList.innerHTML="";
    if(snap.empty){
      streamList.innerHTML="<small>é…ä¿¡ãªã—</small>";
      return;
    }
    snap.forEach(d=>{
      const s=d.data();
      streamList.innerHTML+=`
      <div class="panel row">
        <img src="${s.ownerIcon}" class="avatar">
        <div class="col">
          <strong>${s.title}</strong><br>
          <small>${s.ownerName}</small>
        </div>
        <button class="btn-gray" onclick="joinViewer('${d.id}','${s.title}')">è¦–è´</button>
        ${isAdmin?`<button class="btn-gray" onclick="deleteStream('${d.id}')">ğŸ—‘</button>`:""}
      </div>`;
    });
  }
);

/* ç®¡ç†è€… */
window.deleteStream=async(id)=>{
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))
    await deleteDoc(doc(db,"liveStreams",id));
};

window.openAdmin=()=>{
  home.classList.add("hidden");
  adminSetup.classList.remove("hidden");
};

window.startLive=async()=>{
  const ref=await addDoc(collection(db,"liveStreams"),{
    title:streamTitle.value||"ç„¡é¡Œ",
    ownerName:myName,
    ownerIcon:myAvatar,
    createdAt:Date.now(),
    vote:0
  });
  joinViewer(ref.id,streamTitle.value||"ç„¡é¡Œ");
};

/* Viewer */
window.joinViewer=(id,title)=>{
  currentStreamId=id;
  viewerTitle.textContent=title;
  home.classList.add("hidden");
  adminSetup.classList.add("hidden");
  viewer.classList.remove("hidden");

  addDoc(collection(db,"liveStreams",id,"viewers"),{t:Date.now()});

  onSnapshot(collection(db,"liveStreams",id,"viewers"),
    s=>viewerCount.textContent=s.size);

  onSnapshot(doc(db,"liveStreams",id),
    d=>voteResult.innerHTML=`<small>æŠ•ç¥¨ï¼š${d.data().vote}</small>`);

  onSnapshot(
    query(collection(db,"liveStreams",id,"comments"),orderBy("time")),
    s=>{
      commentList.innerHTML="";
      s.forEach(d=>{
        const c=d.data();
        commentList.innerHTML+=`<small>${c.name}ï¼š${c.text}</small><br>`;
      });
    }
  );
};

/* Vote / Comment */
window.vote=v=>updateDoc(
  doc(db,"liveStreams",currentStreamId),
  {vote:increment(v)}
);

window.sendComment=()=>{
  if(!commentInput.value)return;
  addDoc(collection(db,"liveStreams",currentStreamId,"comments"),{
    name:myName||"åŒ¿å",
    text:commentInput.value,
    time:Date.now()
  });
  commentInput.value="";
};

window.goHome=()=>location.reload();
</script>

</body>
</html>
